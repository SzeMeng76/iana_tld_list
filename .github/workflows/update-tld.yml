name: Update IANA TLD Data

on:
  schedule:
    # ÊØèÂë®‰∏â UTC 02:00 ËøêË°å (Âåó‰∫¨Êó∂Èó¥Âë®‰∏â 10:00)
    - cron: '0 2 * * 3'
  workflow_dispatch: # ÂÖÅËÆ∏ÊâãÂä®Ëß¶Âèë
  push:
    branches:
      - main
      - master
    paths:
      - '.github/workflows/update-tld.yml'

jobs:
  update-tld-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 lxml aiohttp
        
    - name: Backup old data for comparison
      run: |
        if [ -f "data/tld.json" ]; then
          cp data/tld.json data/tld.json.old
        fi
        
    - name: Run TLD data update
      run: |
        python update_tld.py --non-interactive --overwrite --verbose --force-download
        
    - name: Check for changes
      id: verify-changed-files
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
        else
          echo "changed=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Generate update summary
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        echo "üìä **TLD Data Update Report**" > update_summary.md
        echo "" >> update_summary.md
        echo "üïê **Update Time**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> update_summary.md
        echo "" >> update_summary.md
        
        # Count TLDs
        if [ -f "data/tld.json" ]; then
          TLD_COUNT=$(python3 generate_summary.py count)
          echo "üìà **Total TLDs**: $TLD_COUNT" >> update_summary.md
        else
          echo "‚ùå **TLD data file not found**" >> update_summary.md
        fi
        echo "" >> update_summary.md
        
        # Check for TLD changes
        python3 generate_summary.py compare >> update_summary.md
        
        echo "" >> update_summary.md
        echo "üîÑ **Data Source**: [IANA Root Zone Database](https://www.iana.org/domains/root/db/)" >> update_summary.md
        echo "ü§ñ **Auto-updated**: GitHub Actions" >> update_summary.md
        echo "üì¶ **Original Project**: [jophy/iana_tld_list](https://github.com/jophy/iana_tld_list)" >> update_summary.md
        
    - name: Commit and push changes
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        git add data/
        if [ -f "update_summary.md" ]; then
          git add update_summary.md
        fi
        
        # Create detailed commit message
        COMMIT_MSG="feat: auto-update IANA TLD data - $(date -u '+%Y-%m-%d')"
        
        if [ -f "update_summary.md" ]; then
          git commit -m "$COMMIT_MSG" -m "$(cat update_summary.md)"
        else
          git commit -m "$COMMIT_MSG"
        fi
        git push
        
    - name: Upload TLD data as artifact
      if: steps.verify-changed-files.outputs.changed == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: tld-data-${{ github.run_number }}
        path: |
          data/tld.json
          data/tldlist.txt
          data/tlds-alpha-by-domain.txt
        retention-days: 90

  notify-status:
    needs: update-tld-data
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Report status
      run: |
        if [ "${{ needs.update-tld-data.result }}" == "success" ]; then
          echo "‚úÖ TLD data update workflow completed successfully"
        else
          echo "‚ùå TLD data update workflow failed"
          exit 1
        fi