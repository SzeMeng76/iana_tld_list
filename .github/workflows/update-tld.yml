name: Update IANA TLD Data

on:
  schedule:
    # ÊØèÂë®‰∏â UTC 02:00 ËøêË°å (Âåó‰∫¨Êó∂Èó¥Âë®‰∏â 10:00)
    - cron: '0 2 * * 3'
  workflow_dispatch: # ÂÖÅËÆ∏ÊâãÂä®Ëß¶Âèë
  push:
    branches:
      - main
      - master
    paths:
      - '.github/workflows/update-tld.yml'

jobs:
  update-tld-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 lxml aiohttp
        
    - name: Backup old data for comparison
      run: |
        if [ -f "data/tld.json" ]; then
          cp data/tld.json data/tld.json.old
        fi
        
    - name: Run TLD data update
      run: |
        python update_tld.py --non-interactive --overwrite --verbose --force-download
        
    - name: Check for changes
      id: verify-changed-files
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
        else
          echo "changed=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Generate update summary
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        echo "üìä **TLD Data Update Report**" > update_summary.md
        echo "" >> update_summary.md
        echo "üïê **Update Time**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> update_summary.md
        echo "" >> update_summary.md
        
        # Count TLDs
        if [ -f "data/tld.json" ]; then
          TLD_COUNT=$(python3 -c "
import json
try:
    with open('data/tld.json', 'r') as f:
        data = json.load(f)
        if isinstance(data, dict):
            print(len(data))
        elif isinstance(data, list):
            print(len(data))
        else:
            print('Unknown format')
except Exception as e:
    print(f'Error: {e}')
")
          echo "üìà **Total TLDs**: $TLD_COUNT" >> update_summary.md
        else
          echo "‚ùå **TLD data file not found**" >> update_summary.md
        fi
        echo "" >> update_summary.md
        
        # Check for TLD changes
        if [ -f "data/tld.json.old" ] && [ -f "data/tld.json" ]; then
          python3 -c "
import json
try:
    with open('data/tld.json.old', 'r') as f:
        old_data = json.load(f)
    with open('data/tld.json', 'r') as f:
        new_data = json.load(f)
        
    # Handle different data formats
    if isinstance(old_data, dict):
        old_tlds = set(old_data.keys())
    elif isinstance(old_data, list):
        old_tlds = set(item.get('tld', item.get('dm', '')) for item in old_data)
    else:
        old_tlds = set()
        
    if isinstance(new_data, dict):
        new_tlds = set(new_data.keys())
    elif isinstance(new_data, list):
        new_tlds = set(item.get('tld', item.get('dm', '')) for item in new_data)
    else:
        new_tlds = set()
        
    added = new_tlds - old_tlds
    removed = old_tlds - new_tlds
    
    if added:
        print('üÜï **Added TLDs**:')
        for tld in sorted(added)[:20]:  # Show first 20
            print(f'  - {tld}')
        if len(added) > 20:
            print(f'  - ... and {len(added)-20} more')
        print()
        
    if removed:
        print('üóëÔ∏è **Removed TLDs**:')
        for tld in sorted(removed)[:20]:  # Show first 20
            print(f'  - {tld}')
        if len(removed) > 20:
            print(f'  - ... and {len(removed)-20} more')
        print()
        
    if not added and not removed:
        print('‚úÖ **No TLD changes, data refreshed**')
        
except Exception as e:
    print(f'‚ö†Ô∏è Unable to compare differences: {e}')
" >> update_summary.md
        fi
        
        echo "" >> update_summary.md
        echo "üîÑ **Data Source**: [IANA Root Zone Database](https://www.iana.org/domains/root/db/)" >> update_summary.md
        echo "ü§ñ **Auto-updated**: GitHub Actions" >> update_summary.md
        echo "üì¶ **Original Project**: [jophy/iana_tld_list](https://github.com/jophy/iana_tld_list)" >> update_summary.md
        
    - name: Commit and push changes
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        git add data/
        if [ -f "update_summary.md" ]; then
          git add update_summary.md
        fi
        
        # Create detailed commit message
        COMMIT_MSG="feat: auto-update IANA TLD data - $(date -u '+%Y-%m-%d')"
        
        if [ -f "update_summary.md" ]; then
          git commit -m "$COMMIT_MSG" -m "$(cat update_summary.md)"
        else
          git commit -m "$COMMIT_MSG"
        fi
        git push
        
    - name: Create Release
      if: steps.verify-changed-files.outputs.changed == 'true'
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: "v$(date +'%Y.%m.%d')"
        name: "TLD Data Update - $(date +'%Y-%m-%d')"
        body_path: update_summary.md
        draft: false
        prerelease: false
        files: |
          data/tld.json
          data/tldlist.txt
          data/tlds-alpha-by-domain.txt
          
    - name: Upload TLD data as artifact
      if: steps.verify-changed-files.outputs.changed == 'true'
      uses: actions/upload-artifact@v3
      with:
        name: "tld-data-$(date +'%Y%m%d')"
        path: |
          data/tld.json
          data/tldlist.txt
          data/tlds-alpha-by-domain.txt
        retention-days: 90

  notify-status:
    needs: update-tld-data
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Report status
      run: |
        if [ "${{ needs.update-tld-data.result }}" == "success" ]; then
          echo "‚úÖ TLD data update workflow completed successfully"
        else
          echo "‚ùå TLD data update workflow failed"
          exit 1
        fi